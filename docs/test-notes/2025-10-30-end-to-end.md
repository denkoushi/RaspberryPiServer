# 2025-10-30 End-to-End Scan → Viewer 検証ログ

## 概要
- 目的: Window A (Pi4) から RaspberryPiServer (Pi5) へ `POST /api/v1/scans` を送信し、DocumentViewer が Socket.IO イベントで PDF を自動表示するまでの一連フローを確認する。
- 実施者: tools02
- 環境差異: 会社↔自宅の移動に伴い LAN セグメントが `192.168.10.x` から `192.168.128.x` へ変更。

## 手順と結果
1. **Pi5 (RaspberryPiServer) のホスト名を固定**
   - `sudo hostnamectl set-hostname raspi-server`
   - 再起動後に `hostname -I` → `192.168.128.128` を確認。

2. **Pi4 (Window A) の `/etc/hosts` から旧 IP を削除**
   - `sudo sed -i '/raspi-server.local/d' /etc/hosts`
   - `ping raspi-server.local` → 新しい IP へ疎通できることを確認。

3. **REST API テスト**
   - コマンド:
     ```bash
     curl -s -X POST http://raspi-server.local:8501/api/v1/scans \
       -H "Authorization: Bearer ${API_TOKEN:-raspi-token-20251027}" \
       -H "Content-Type: application/json" \
       -d '{
             "part_code": "testpart",
             "location_code": "RACK-A1",
             "device_id": "window-a-test"
           }'
     ```
   - 結果: `HTTP 201` / `accepted: true`。

4. **Socket.IO イベント確認 (Pi5)**
   - `sudo docker compose exec -T app python /app/tests/socketio_listener.py` を起動。
   - 手順3の `curl` 実行後、以下のイベントを受信: `part_location_updated`, `scan_update`。

5. **DocumentViewer 表示確認 (Pi4)**
   - `http://localhost:8501/viewer` で `testpart.pdf` が自動表示されることを確認。

## 所見
- 名前解決に `/etc/hosts` の固定 IP を用いると LAN 切り替え時にトラブルになる。Pi5 のホスト名を `raspi-server` に固定し、クライアントは Avahi (mDNS) に任せる運用へ変更。
- Socket.IO リスナーがイベントを受信することを確認済み。Viewer の自動表示も正常。

## TODO / フォローアップ
- Window A 構築手順に mDNS 確認コマンドを追記（実施済み: tool-management-system02/RUNBOOK.md 反映）。
- Pi4 側で日次チェック時に `ping raspi-server.local` → `curl /api/v1/scans` → Viewer 確認をルーチン化する。
